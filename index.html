<div style="max-width:620px;margin:40px auto;padding:32px;background:#fff;
            border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,0.07);
            font-family:'Segoe UI',sans-serif;color:#1a1a1a;">

  <h2 style="text-align:center;font-size:24px;font-weight:700;
             margin-bottom:30px;color:#5a52ff;">
    Signalez une coupure d’électricité dans votre ville
  </h2>

  <!-- Conteneur relatif pour le champ + suggestions -->
  <div style="position:relative;margin-bottom:28px;">
    <input id="ville" type="text" placeholder="Ex. : Coutances"
           style="width:100%;padding:14px 16px;border:2px solid #5a52ff;
                  border-radius:10px;font-size:16px;box-sizing:border-box;"
    >
    <ul id="suggestions" style="
         list-style:none;
         margin:4px 0 0 0;
         padding:0;
         position:absolute;
         top:100%;
         left:0;
         right:0;
         background:#fff;
         border:1px solid #5a52ff;
         border-top:none;
         max-height:160px;
         overflow-y:auto;
         box-shadow:0 4px 12px rgba(0,0,0,0.1);
         z-index:100;
         display:none;
       "></ul>
  </div>

  <label style="font-weight:600;display:block;margin-bottom:12px;">
    Avez-vous eu une coupure ?
  </label>
  <div style="display:flex;gap:20px;margin-bottom:32px;">
    <label class="opt" data-value="Oui"
           style="flex:1;background:#f1f3ff;padding:14px 16px;border-radius:10px;
                  text-align:center;cursor:pointer;border:2px solid transparent;
                  transition:border-color .2s;">Oui</label>
    <label class="opt" data-value="Non"
           style="flex:1;background:#f1f3ff;padding:14px 16px;border-radius:10px;
                  text-align:center;cursor:pointer;border:2px solid transparent;
                  transition:border-color .2s;">Non</label>
  </div>

  <button id="submitBtn"
          style="width:100%;padding:16px;background:linear-gradient(to right,#5a52ff,#0fc4b2);
                 color:#fff;border:none;border-radius:12px;font-size:17px;font-weight:bold;
                 cursor:pointer;transition:background .3s;">Envoyer</button>

  <p id="confirmation"
     style="display:none;margin-top:20px;color:#5a52ff;text-align:center;font-weight:600;">
    Merci, votre réponse a bien été envoyée !
  </p>
</div>

<script>
  let validCities = [];
  let choixCoupure = "";

  document.addEventListener("DOMContentLoaded", () => {
    const input = document.getElementById("ville");
    const suggestions = document.getElementById("suggestions");
    const opts = document.querySelectorAll(".opt");
    const btn = document.getElementById("submitBtn");

    // 1) Requête Nominatim et affichage des suggestions
    input.addEventListener("input", () => {
      const q = input.value.trim();
      if (q.length < 2) {
        suggestions.style.display = "none";
        return;
      }
      fetch(`https://nominatim.openstreetmap.org/search?city=${encodeURIComponent(q)}&country=France&format=json&limit=5`)
        .then(res => res.json())
        .then(list => {
          suggestions.innerHTML = "";
          validCities = [];
          list.forEach(item => {
            const name = item.display_name.split(',')[0];
            if (!validCities.includes(name)) {
              validCities.push(name);
              const li = document.createElement('li');
              li.textContent = name;
              li.style.cssText = `
                padding:10px 14px;
                cursor:pointer;
                border-bottom:1px solid #eee;
                transition:background .2s;
              `;
              li.onmouseover = () => li.style.background = '#f0f4ff';
              li.onmouseout  = () => li.style.background = '';
              li.onclick = () => {
                input.value = name;
                suggestions.style.display = 'none';
              };
              suggestions.appendChild(li);
            }
          });
          suggestions.style.display = validCities.length ? 'block' : 'none';
        })
        .catch(() => { suggestions.style.display = 'none' });
    });

    // 2) Oui/Non
    opts.forEach(label => {
      label.addEventListener("click", () => {
        choixCoupure = label.dataset.value;
        opts.forEach(l => l.style.borderColor = "transparent");
        label.style.borderColor = "#ffb81d";
      });
    });

    // 3) Envoi
    btn.addEventListener("click", () => {
      const city = input.value.trim();
      if (!city || !choixCoupure || !validCities.includes(city)) {
        alert("Merci de choisir une ville valide et de répondre à la question.");
        return;
      }
      fetch("TON_URL_APPS_SCRIPT", {
        method: "POST", mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ville: city, coupure: choixCoupure })
      });
      input.value = "";
      choixCoupure = "";
      opts.forEach(l => l.style.borderColor = "transparent");
      document.getElementById("confirmation").style.display = "block";
    });

    // 4) Fermer suggestions si clic à l'extérieur
    document.addEventListener("click", e => {
      if (!e.target.closest('#ville')) {
        suggestions.style.display = 'none';
      }
    });
  });
</script>
